#!/usr/bin/env python


import sys
import json
import argparse
# убрать
from jsondiff import diff
#задефайнить класс в файл

import os
import hashlib
import json


class Walk:
    list_of_files = []
    output_file = 'output_without_check.json' #добавить в параметры, но использовать по дефолту
    output_file_check = 'output_with_check.json' #убираем, вывод теперь только в консоль и работаем с памятью

    def print_usage():
        print('Usage: python dir_check.py -d <dir_to_check> or python dir_check.py -c -d <dir_to_check> to check diff')


#переписать на итератор с использованием функции yield
    def walk_directory(self, dir_to_check, output_file, blocksize: int = 4096):
        for root, directories, files in os.walk(dir_to_check, topdown=False):
            for name in files:
                hasher_fn = hashlib.md5()
                with open((os.path.join(root, name)), 'rb') as afile:
                    try:
                        buf = afile.read(blocksize)
                        hasher_fn.update(buf)
                        files_md5sum = {os.path.join(root, name): hasher_fn.hexdigest()}
                        Walk.list_of_files.append(files_md5sum)
                    except KeyError:
                        print('Error: {} '.format(KeyError))
                    finally:
                        with open(output_file, 'w') as f:
                            f.write(json.dumps(Walk.list_of_files, indent=2, sort_keys=True))

#проверить, как считается md5 у бинарных файлов
#до и после модуль timeit - измерять время работы скрипта для режима check ( сгенерить 1000 файлов ) суммарное время и среднее за 10к прогонов


#задефайнить коды возврата
BAD_ARGUMENTS_ERROR = 1



#убрать в main
# parser = argparse.ArgumentParser()
# parser.add_argument('-c', '--check', action='store_true',
#                     help="Check previously file for diff")
# #добавить больше директорий
# parser.add_argument('-d', '--directory', nargs=1, type=str,
#                     help="Recursive check md5sum file and write to file")
# args = parser.parse_args()
#убрать -d из аргументов
#ключ для вывода в консоль stdout
#ключ quiet (или silent), который убирает весь оутпут

def __main__(args=None):
    if args is None:
        args = sys.argv[1:]

    d = Walk
    # print(args)
    if len(args) not in range(2, 3):
        d.print_usage()
        return BAD_ARGUMENTS_ERROR

    # убрать в main
    parser = argparse.ArgumentParser()
    parser.add_argument('-c', '--check', action='store_true',
                        help="Check previously file for diff")
    # добавить больше директорий
    parser.add_argument('-d', '--directory', nargs=1, type=str,
                        help="Recursive check md5sum file and write to file")
    args = parser.parse_args(args)
    # убрать -d из аргументов
    # ключ для вывода в консоль stdout
    # ключ quiet (или silent), который убирает весь оутпут

    if args.check:
        try:
            with open(d.output_file) as json_file:
                output_file_json = json.load(json_file)
            d.walk_directory(None, str(args.directory[0]), d.output_file_check)
            if diff(d.list_of_files, output_file_json):
                print(diff(output_file_json, d.list_of_files))
                return 1
            else:
                return 0
        except KeyError:
            print('Error: {} '.format(KeyError))
    else:
        #добавить параметр для названия файла
        d.walk_directory(None, str(args.directory[0]), d.output_file)




if __name__ == '__main__':
    sys.exit(__main__())
